

# STB Chain — шпаргалка (Local Devnet: 2 ноды / 2 валидатора)

> Цель: быстро **поднять 2-нodовый devnet**, понимать **какие порты где**, уметь делать **mint/burn** и **проверять**, а также быстро чинить типовые ошибки (LOCK, priv_validator_state.json, address already in use, нет пиров и т.д.).

---

## 0) Обозначения

- **Node1 home:** `~/.stbnode1`
- **Node2 home:** `~/.stbnode2`
- **Chain ID:** `stbchain-local`
- **Denom стейбла:** `ustb`
- **Базовый denom комиссий/стейка:** `stake`

### Порты (по умолчанию в твоих командах)

| Нода | RPC (CometBFT) | P2P | gRPC | API (REST) |
|---|---:|---:|---:|---:|
| node1 | `127.0.0.1:26657` | `0.0.0.0:26656` | `localhost:9090` | `localhost:1317` |
| node2 | `127.0.0.1:26667` | `0.0.0.0:26666` | (можно поменять) | (лучше выключить/поменять) |

> Важно: **API/REST и gRPC** у второй ноды по умолчанию могут конфликтовать по портам. Если нужно — задавай отдельные порты или отключай.

---

## 1) Быстрые команды: старт/стоп/проверка процессов

### Остановить все ноды
```bash
pkill -f stbchaind || true
```

### Посмотреть запущенные процессы
```bash
ps aux | grep stbchaind | grep -v grep
```

### Убить только node1 / node2 по home
```bash
pkill -f "/Users/egorgladkih/.stbnode1" || true
pkill -f "/Users/egorgladkih/.stbnode2" || true
```

---

## 2) Инициализация нод (если поднимаешь с нуля)

### 2.1 Node1 init
```bash
rm -rf ~/.stbnode1
stbchaind init node1 --chain-id stbchain-local --home ~/.stbnode1
```

### 2.2 Node2 init
```bash
rm -rf ~/.stbnode2
stbchaind init node2 --chain-id stbchain-local --home ~/.stbnode2
```

> ⚠️ Если ты удаляешь `data/`, то обязательно должна появиться/быть создана структура данных для консенсуса. После `init` файлы создаются.

---

## 3) Genesis + 2 валидатора (gentx flow)

> Ниже — «классический» flow: создаём ключи, добавляем genesis-аккаунты, генерим gentx, собираем gentx в node1, копируем genesis в node2.

### 3.1 Создать ключи валидаторов

#### val1 (на node1)
```bash
stbchaind keys add val1 --home ~/.stbnode1 --keyring-backend test
```

#### val2 (на node2)
```bash
stbchaind keys add val2 --home ~/.stbnode2 --keyring-backend test
```

### 3.2 Узнать адреса
```bash
VAL1_ADDR=$(stbchaind keys show val1 -a --home ~/.stbnode1 --keyring-backend test)
echo $VAL1_ADDR

VAL2_ADDR=$(stbchaind keys show val2 -a --home ~/.stbnode2 --keyring-backend test)
echo $VAL2_ADDR
```

### 3.3 Добавить genesis-аккаунты

> ⚠️ У тебя команда **не** `add-genesis-account`, а команда из твоего бинари/версии. Ниже — 2 варианта.

#### Вариант A (если есть `genesis add-genesis-account`)
```bash
stbchaind genesis add-genesis-account $VAL1_ADDR 200000000stake --home ~/.stbnode1
stbchaind genesis add-genesis-account $VAL2_ADDR 100000000stake --home ~/.stbnode1
```

#### Вариант B (если у тебя другой подкомандой добавляется аккаунт)
> Используй **ровно ту команду**, которой ты уже «сделал готово» у себя. (Оставлено как напоминание.)

### 3.4 Сгенерировать gentx для каждого валидатора

#### gentx для val1 (на node1)
```bash
stbchaind genesis gentx val1 10000000stake \
  --home ~/.stbnode1 \
  --keyring-backend test \
  --chain-id stbchain-local
```

#### gentx для val2 (на node2)
```bash
stbchaind genesis gentx val2 50000000stake \
  --home ~/.stbnode2 \
  --keyring-backend test \
  --chain-id stbchain-local
```

> Если получаешь ошибку вида:
> `does not have a balance in the genesis state` — значит ты **не добавил** адрес в genesis (см. шаг 3.3).

### 3.5 Скопировать gentx val2 в node1 и собрать genesis

```bash
# Копируем gentx из node2 в node1
cp ~/.stbnode2/config/gentx/*.json ~/.stbnode1/config/gentx/

# Собираем все gentx в node1
stbchaind genesis collect-gentxs --home ~/.stbnode1

# (рекомендуется) проверить генезис
stbchaind genesis validate-genesis --home ~/.stbnode1
```

### 3.6 Скопировать финальный genesis в node2
```bash
cp ~/.stbnode1/config/genesis.json ~/.stbnode2/config/genesis.json
```

---

## 4) Запуск 2 нод (node2 цепляется к node1)

### 4.1 Узнать Node1 ID
```bash
NODE1_ID=$(stbchaind tendermint show-node-id --home ~/.stbnode1)
echo $NODE1_ID
```

### 4.2 Старт Node1
```bash
stbchaind start \
  --home ~/.stbnode1 \
  --minimum-gas-prices "0stake"
```

### 4.3 Старт Node2 (другие порты + persistent peer)
```bash
stbchaind start \
  --home ~/.stbnode2 \
  --minimum-gas-prices "0stake" \
  --rpc.laddr tcp://127.0.0.1:26667 \
  --p2p.laddr tcp://0.0.0.0:26666 \
  --p2p.persistent_peers "${NODE1_ID}@127.0.0.1:26656"
```

---

## 5) Проверки сети (RPC/REST)

### 5.1 Высота блока на обеих нодах
```bash
curl -s http://127.0.0.1:26657/status | jq -r '.result.sync_info.latest_block_height'
curl -s http://127.0.0.1:26667/status | jq -r '.result.sync_info.latest_block_height'
```

### 5.2 Сколько пиров у node2 (должно быть хотя бы 1)
```bash
curl -s http://127.0.0.1:26667/net_info | jq '.result.n_peers'
```

### 5.3 Проверка, что блок подписан двумя валидаторами
```bash
H=$(curl -s http://127.0.0.1:26657/status | jq -r '.result.sync_info.latest_block_height')

curl -s "http://127.0.0.1:26657/block?height=$H" \
| jq '.result.block.last_commit.signatures | length'
```

### 5.4 Проверка валидаторов (должно быть 2 bonded)
```bash
stbchaind query staking validators --node tcp://127.0.0.1:26657 | head -n 120
```

### 5.5 REST node_info (если API включен)
```bash
curl -s http://localhost:1317/cosmos/base/tendermint/v1beta1/node_info | head
```

---

## 6) Stablecoin: параметры, issuer, mint, burn

### 6.1 Параметры модуля (denom/issuer/max_supply)
```bash
stbchaind query stablecoin params --node tcp://127.0.0.1:26657
```

### 6.2 Получить адрес issuer (val1)
```bash
ISSUER=$(stbchaind keys show val1 -a --home ~/.stbnode1 --keyring-backend test)
echo $ISSUER
```

> Переменная `$ISSUER` вставляется сюда:
> `--to-address "$ISSUER"` или `--from-address "$ISSUER"`

### 6.3 Проверить балансы issuer
```bash
stbchaind query bank balances $ISSUER --node tcp://127.0.0.1:26657
stbchaind query bank balance  $ISSUER ustb  --node tcp://127.0.0.1:26657
```

### 6.4 Supply ustb
```bash
stbchaind query bank total-supply-of ustb --node tcp://127.0.0.1:26657
stbchaind query bank total-supply        --node tcp://127.0.0.1:26657 | grep -n ustb || true
```

### 6.5 Mint (правильно)

> В твоей реализации CLI ожидает **число** в `--amount`, а denom (`ustb`) подставляется модулем.

```bash
stbchaind tx stablecoin mint \
  --amount 1000 \
  --to-address "$ISSUER" \
  --from val1 \
  --home ~/.stbnode1 \
  --keyring-backend test \
  --node tcp://127.0.0.1:26657 \
  --chain-id stbchain-local \
  --fees 5000stake \
  -y
```

### 6.6 Burn (правильно)

> `--from-address` — это адрес, **с которого сжигаем** ustb.

```bash
stbchaind tx stablecoin burn \
  --amount 1 \
  --from-address "$ISSUER" \
  --from val1 \
  --home ~/.stbnode1 \
  --keyring-backend test \
  --node tcp://127.0.0.1:26657 \
  --chain-id stbchain-local \
  --fees 5000stake \
  -y
```

### 6.7 Проверка, что non-issuer не может mint/burn

#### Mint от val2 (должно упасть `not issuer`)
```bash
stbchaind tx stablecoin mint \
  --amount 1 \
  --to-address "$ISSUER" \
  --from val2 \
  --home ~/.stbnode2 \
  --keyring-backend test \
  --node tcp://127.0.0.1:26657 \
  --chain-id stbchain-local \
  --fees 5000stake \
  -y
```

#### Burn от val2 (должно упасть `not issuer`)
```bash
stbchaind tx stablecoin burn \
  --amount 1 \
  --from-address "$ISSUER" \
  --from val2 \
  --home ~/.stbnode2 \
  --keyring-backend test \
  --node tcp://127.0.0.1:26657 \
  --chain-id stbchain-local \
  --fees 5000stake \
  -y
```

### 6.8 Проверка tx по хэшу
```bash
stbchaind query tx <TX_HASH> --node tcp://127.0.0.1:26657
```

---

## 7) Демонстрация остановки блоков (2 валидатора → нужен кворум)

> При 2 валидаторах, если один выключить — вторая нода **не сможет финализировать блоки** (нет 2/3 подписей).

### 7.1 Быстро остановить node2
```bash
pkill -f "/Users/egorgladkih/.stbnode2" || true
```

### 7.2 Проверить, что height на node1 перестала расти
```bash
curl -s http://127.0.0.1:26657/status | jq -r '.result.sync_info.latest_block_height'
# подожди 3-5 сек и повтори — число должно быть тем же
```

### 7.3 Вернуть node2
```bash
NODE1_ID=$(stbchaind tendermint show-node-id --home ~/.stbnode1)

stbchaind start \
  --home ~/.stbnode2 \
  --minimum-gas-prices "0stake" \
  --rpc.laddr tcp://127.0.0.1:26667 \
  --p2p.laddr tcp://0.0.0.0:26666 \
  --p2p.persistent_peers "${NODE1_ID}@127.0.0.1:26656"
```

---

## 8) Типовые ошибки и быстрые фиксы

### 8.1 `failed to initialize database: resource temporarily unavailable`
Причина: висит процесс или **LOCK** файл в LevelDB.

Фикс:
```bash
# убить процессы
pkill -f stbchaind || true

# снести LOCK-и
rm -f ~/.stbnode1/data/application.db/LOCK
rm -f ~/.stbnode2/data/application.db/LOCK

# (если есть) cometbft DB lock
rm -f ~/.stbnode1/data/*/LOCK 2>/dev/null || true
rm -f ~/.stbnode2/data/*/LOCK 2>/dev/null || true
```

### 8.2 `open .../data/priv_validator_state.json: no such file or directory`
Причина: ты удалил `data/` и не восстановил нужные файлы.

Фикс (самый простой):
```bash
# если совсем новая нода — просто init (создаст структуру)
stbchaind init node1 --chain-id stbchain-local --home ~/.stbnode1
stbchaind init node2 --chain-id stbchain-local --home ~/.stbnode2
```

Если генезис уже готов — после init снова скопируй `genesis.json` (и при необходимости ключи/конфиги).

### 8.3 `listen tcp 127.0.0.1:26657: bind: address already in use`
Причина: порт занят (обычно node1 уже запущена).

Фикс:
```bash
lsof -i tcp:26657
# либо убей процесс, либо используй другой --rpc.laddr
```

### 8.4 Node2 «не делает блоки» / `No addresses to dial. Falling back to seeds`
Причина: нет peers (не задан `persistent_peers`, нет seeds).

Фикс:
```bash
NODE1_ID=$(stbchaind tendermint show-node-id --home ~/.stbnode1)

# перезапусти node2 с persistent peer
stbchaind start \
  --home ~/.stbnode2 \
  --minimum-gas-prices "0stake" \
  --rpc.laddr tcp://127.0.0.1:26667 \
  --p2p.laddr tcp://0.0.0.0:26666 \
  --p2p.persistent_peers "${NODE1_ID}@127.0.0.1:26656"
```

### 8.5 `validator set is empty after InitGenesis`
Причина: в genesis нет валидаторов с достаточной делегацией.

Фикс: убедись, что есть gentx и он собран:
```bash
stbchaind genesis collect-gentxs --home ~/.stbnode1
stbchaind genesis validate-genesis --home ~/.stbnode1
```

---

## 9) Полный reset сети (ОСТОРОЖНО: удалит состояние)

> Это удаляет **только data** (состояние), **не трогая** config/keys.

```bash
pkill -f stbchaind || true
rm -rf ~/.stbnode1/data ~/.stbnode2/data
```

После reset:
- стартуй node1
- стартуй node2 с `persistent_peers`

---

## 10) Полезные `--help`

```bash
stbchaind --help
stbchaind start --help
stbchaind query --help
stbchaind tx --help

stbchaind tx stablecoin --help
stbchaind tx stablecoin mint --help
stbchaind tx stablecoin burn --help

stbchaind query stablecoin --help
stbchaind query bank --help
stbchaind query staking --help
```